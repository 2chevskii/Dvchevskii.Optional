name: push-release-artifacts
on:
  release:
    types: published
jobs:
  push-nuget:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - nuget_feed_name: nuget.org
            nuget_feed_url: https://api.nuget.org/v3/index.json
            nuget_api_key: NUGET_API_KEY
            nuget_deploy_env_name: nuget-org
          - nuget_feed_name: github.com
            nuget_feed_url: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
            nuget_api_key: GITHUB_TOKEN
            nuget_deploy_env_name: github-nuget-feed
    steps:
      - name: âœ… Repository checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: ./global.json
      - name: ğŸ“¥ Download release assets
        run: ./build.sh DownloadReleaseAssets --release-assets artifacts/release --release-tag-name ${{ github.event.release.tag_name }}
      - name: ğŸšš Push packages to NuGet feed
        id: push
        run: >
          ./build.sh NuGetPush
          --release-assets artifacts/release
          --nuget-feed-name ${{ matrix.nuget_feed_name }}
          --nuget-feed-url '${{ matrix.nuget_feed_url }}'
          --nuget-api-key ${{ secrets[matrix.nuget_api_key] }}
    environment:
      name: ${{ matrix.nuget_deploy_env_name }}
      url: ${{ steps.push.outputs.nuget_deploy_url }}
